
> supabase-recipe-scraper@1.0.0 test:universal /Users/orensegal/Documents/GitHub/typescript_scraper_service
> npx tsx test-universal-scraper.ts

ğŸ”— Initializing master ingredients table...
âœ… Master ingredients table initialized with 32 ingredients
ğŸ§ª TESTING UNIVERSAL RECIPE SCRAPER

================================================================================

TEST 1: Regular Recipe Websites
--------------------------------------------------------------------------------

ğŸ” Testing [WEBSITE]: https://www.allrecipes.com/recipe/12151/banana-banana-bread/
ğŸ” Detected content type: website
â„¹ï¸ Redis disabled - using memory cache only
âŒ Cache MISS: https://www.allrecipes.com/recipe/12151/banana-banana-bread/

ğŸ¯ MULTI-SOURCE AGGREGATION for: "12151"
   URL: https://www.allrecipes.com/recipe/12151/banana-banana-bread/

ğŸ“ PHASE 1: Multi-API Search
ğŸ” Enhanced search for "12151"
   Trying 1 variations: [12151]
ğŸŒ TheMealDB API request: https://www.themealdb.com/api/json/v1/1/search.php?s=12151
âš ï¸  No recipes found in TheMealDB
   âŒ No matches found in TheMealDB
ğŸŒ RecipePuppy API request: 12151
âš ï¸  No recipes found in RecipePuppy
ğŸŒ Wikidata SPARQL query: 12151
âš ï¸  No recipes found in Wikidata
ğŸ”Œ Connected to HowToCook MCP server
ğŸ”Œ Connected to MCP-Cook server
ğŸŒ DummyJSON API request: fetching all recipes
âœ… Found 50 recipes from DummyJSON

ğŸ“ PHASE 2: Web Scraping
âŒ Cache MISS: https://www.allrecipes.com/recipe/12151/banana-banana-bread/
ğŸ” Starting robust scraping for: https://www.allrecipes.com/recipe/12151/banana-banana-bread/
  ğŸ”„ Attempting method: json-ld
ğŸ“‹ Loaded 3 blocked sites from registry
ğŸ”„ Retrying in 972ms...
  â³ Retry 1/3 after error: Failed to fetch URL (404): Not Found
ğŸ”„ Retrying in 999ms...
  â³ Retry 2/3 after error: Failed to fetch URL (404): Not Found
ğŸ”„ Retrying in 843ms...
  âŒ json-ld failed: Failed to fetch URL (404): Not Found
  ğŸ”„ Attempting method: microdata
â³ Rate limiting for www.allrecipes.com: waiting 830ms
ğŸ”„ Retrying in 976ms...
  â³ Retry 1/3 after error: Failed to fetch URL (404): Not Found
ğŸ”„ Retrying in 981ms...
  â³ Retry 2/3 after error: Failed to fetch URL (404): Not Found
  âŒ microdata failed: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  ğŸ”„ Attempting method: site-specific
  â³ Retry 1/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  â³ Retry 2/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  âŒ site-specific failed: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  ğŸ”„ Attempting method: generic
  â³ Retry 1/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  â³ Retry 2/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  âŒ generic failed: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  ğŸ”„ Attempting method: playwright
  ğŸ­ Launching Playwright browser with stealth mode...
  â³ Retry 1/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  â³ Retry 2/3 after error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
  âŒ playwright failed: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.
   âŒ Web Scraping failed: All scraping methods failed. Last error: Domain www.allrecipes.com is blocked due to excessive errors. Skipping.

ğŸ” DEDUPLICATION CHECK (0 results)
   âœ… No duplicates found - all 0 sources are unique
ğŸŒ Final fallback: direct web scraping...
ğŸš« Website is blocked due to repeated failures: https://www.allrecipes.com/recipe/12151/banana-banana-bread/

ğŸ” Testing [WEBSITE]: https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-rec...
ğŸ” Detected content type: website
âŒ Cache MISS: https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-recipe-1939524

ğŸ¯ MULTI-SOURCE AGGREGATION for: "alton brown"
   URL: https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-recipe-1939524

ğŸ“ PHASE 1: Multi-API Search
ğŸ” Enhanced search for "alton brown"
   Trying 1 variations: [alton brown]
ğŸŒ TheMealDB API request: https://www.themealdb.com/api/json/v1/1/search.php?s=alton%20brown
âš ï¸  No recipes found in TheMealDB
   âŒ No matches found in TheMealDB
ğŸŒ RecipePuppy API request: alton brown
âš ï¸  No recipes found in RecipePuppy
ğŸŒ Wikidata SPARQL query: alton brown
âš ï¸  No recipes found in Wikidata

ğŸ“ PHASE 2: Web Scraping
âŒ Cache MISS: https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-recipe-1939524
ğŸ” Starting robust scraping for: https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-recipe-1939524
  ğŸ”„ Attempting method: json-ld
âœ… Successfully fetched https://www.foodnetwork.com/recipes/alton-brown/baked-macaroni-and-cheese-recipe-1939524 (attempt 1)
  âœ… Success with json-ld (confidence: 96%)
   âœ… Web Scraping: 75% complete (json-ld)

ğŸ” DEDUPLICATION CHECK (1 results)
   âœ… No duplicates found - all 1 sources are unique

ğŸ“Š COMBINING 1 SOURCES
   âœ… Final recipe: 75% complete, 96% confidence
   ğŸ“š Sources used: web-scraping
âœ… SUCCESS (1524ms)
   Content Type: website
   Method: multi-source-web-scraping
   Confidence: 96%
   Extraction Methods: [web-scraping]
   Title: Baked Macaroni and Cheese
   Ingredients: 14
   Instructions: 6


TEST 2: TikTok Videos
--------------------------------------------------------------------------------
âš ï¸  Note: TikTok scraping requires valid video URLs

ğŸ” Testing [TIKTOK]: https://www.tiktok.com/@cooking/video/7123456789012345678
ğŸ” Detected content type: tiktok
âŒ Cache MISS: https://www.tiktok.com/@cooking/video/7123456789012345678
ğŸµ Scraping TikTok video with enhanced scraper...

ğŸ¥ Scraping video recipe: https://www.tiktok.com/@cooking/video/7123456789012345678
ğŸ“ Platform: tiktok


TEST 3: Instagram Posts
--------------------------------------------------------------------------------
âš ï¸  Note: Instagram scraping requires valid post URLs

ğŸ” Testing [INSTAGRAM]: https://www.instagram.com/p/ABC123XYZ/
ğŸ” Detected content type: instagram
âŒ Cache MISS: https://www.instagram.com/p/ABC123XYZ/
ğŸ“¸ Scraping Instagram post with enhanced scraper...

ğŸ¥ Scraping video recipe: https://www.instagram.com/p/ABC123XYZ/
ğŸ“ Platform: instagram
ğŸ“‹ Video: Instagram Recipe by Unknown
ğŸ“ Extracting content from instagram video...
ğŸ¤ Extracting audio transcript...
ğŸ¤ Transcribing audio...
   Provider: whisper
   Language: en-US
   Downloading media...
   Extracting audio...
ğŸ‘ï¸  Extracting text from video frames (OCR)...
ğŸ§  Parsing recipe from extracted content...
ğŸ“„ Combined text: 16 characters

ğŸ½ï¸  Enriching recipe with nutrition: Instagram
âœ… Successfully scraped recipe: Instagram
âœ… SUCCESS (2468ms)
   Content Type: instagram
   Method: enhanced-video-nlp
   Confidence: 65%
   Extraction Methods: [nlp-parsing, image-ocr, video-ocr, nutrition-enrichment]
   Title: Instagram
   Ingredients: 0
   Instructions: 0
   Images: 0


TEST 4: YouTube Videos
--------------------------------------------------------------------------------

ğŸ” Testing [YOUTUBE]: https://www.youtube.com/watch?v=dQw4w9WgXcQ
ğŸ” Detected content type: youtube
âŒ Cache MISS: https://www.youtube.com/watch?v=dQw4w9WgXcQ
ğŸ¬ Scraping YouTube video with enhanced scraper...

ğŸ¥ Scraping video recipe: https://www.youtube.com/watch?v=dQw4w9WgXcQ
ğŸ“ Platform: youtube
ğŸ“‹ Video: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster) by Rick Astley
ğŸ“ Extracting content from youtube video...
ğŸ¤ Extracting audio transcript...
â„¹ï¸  YouTube caption extraction not implemented, using audio transcription
ğŸ¤ Transcribing audio...
   Provider: whisper
   Language: en-US
   Downloading media...
   Extracting audio...
ğŸ‘ï¸  Extracting text from video frames (OCR)...
ğŸ§  Parsing recipe from extracted content...
ğŸ“„ Combined text: 68 characters

ğŸ½ï¸  Enriching recipe with nutrition: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
ğŸ“‹ Processing 1 ingredients...
ğŸ” Processing ingredient: "Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)"
ğŸ“Š Parse-ingredient result: [
  {
    "quantity": null,
    "quantity2": null,
    "unitOfMeasureID": null,
    "unitOfMeasure": null,
    "description": "Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)",
    "isGroupHeader": false
  }
]
ğŸ†• Created fallback master ingredient: "rick astley -" (ID: c08357707b96)
ğŸ”— Successfully linked "Rick Astley -" to master ingredient (fallback, confidence: 0.30)
âœ… Parsed ingredient with robust linking: {
  name: 'Rick Astley -',
  linked: true,
  master_id: 'c08357707b96',
  method: 'fallback'
}
âœ… Processed 0/1 ingredients
âœ… Found nutrition data for 0/0 ingredients
ğŸ“Š Per serving (1 servings): { calories: 0, protein: 0, fat: 0, carbs: 0 }
âœ… Successfully scraped recipe: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
âœ… SUCCESS (2688ms)
   Content Type: youtube
   Method: enhanced-video-nlp
   Confidence: 65%
   Extraction Methods: [nlp-parsing, youtube-captions, audio-transcript, nutrition-enrichment]
   Title: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
   Ingredients: 1
   Instructions: 0
   Video URL: https://www.youtube.com/watch?v=dQw4w9WgXcQ
   Images: 1

ğŸ” Testing [YOUTUBE]: https://youtu.be/dQw4w9WgXcQ
ğŸ” Detected content type: youtube
âŒ Cache MISS: https://youtu.be/dQw4w9WgXcQ
ğŸ¬ Scraping YouTube video with enhanced scraper...

ğŸ¥ Scraping video recipe: https://youtu.be/dQw4w9WgXcQ
ğŸ“ Platform: youtube
ğŸ“‹ Video: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster) by Rick Astley
ğŸ“ Extracting content from youtube video...
ğŸ¤ Extracting audio transcript...
â„¹ï¸  YouTube caption extraction not implemented, using audio transcription
ğŸ¤ Transcribing audio...
   Provider: whisper
   Language: en-US
   Downloading media...
   Extracting audio...
ğŸ‘ï¸  Extracting text from video frames (OCR)...
ğŸ§  Parsing recipe from extracted content...
ğŸ“„ Combined text: 68 characters

ğŸ½ï¸  Enriching recipe with nutrition: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
ğŸ“‹ Processing 1 ingredients...
ğŸ” Processing ingredient: "Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)"
ğŸ“Š Parse-ingredient result: [
  {
    "quantity": null,
    "quantity2": null,
    "unitOfMeasureID": null,
    "unitOfMeasure": null,
    "description": "Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)",
    "isGroupHeader": false
  }
]
ğŸ”— Successfully linked "Rick Astley -" to master ingredient (fallback, confidence: 0.30)
âœ… Parsed ingredient with robust linking: {
  name: 'Rick Astley -',
  linked: true,
  master_id: 'c08357707b96',
  method: 'fallback'
}
âœ… Processed 0/1 ingredients
âœ… Found nutrition data for 0/0 ingredients
ğŸ“Š Per serving (1 servings): { calories: 0, protein: 0, fat: 0, carbs: 0 }
âœ… Successfully scraped recipe: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
âœ… SUCCESS (2659ms)
   Content Type: youtube
   Method: enhanced-video-nlp
   Confidence: 65%
   Extraction Methods: [nlp-parsing, youtube-captions, audio-transcript, nutrition-enrichment]
   Title: Rick Astley - Never Gonna Give You Up (Official Video) (4K Remaster)
   Ingredients: 1
   Instructions: 0
   Video URL: https://youtu.be/dQw4w9WgXcQ
   Images: 1


TEST 5: Plain Text Parsing
--------------------------------------------------------------------------------

ğŸ” Testing [TEXT]: Chocolate Chip Cookies Recipe

A classic homemade cookie recipe perfect for a...
ğŸ” Detected content type: text
âŒ Cache MISS: Chocolate Chip Cookies Recipe

A classic homemade cookie recipe perfect for any occasion.

Ingredients:
- 2 cups all-purpose flour
- 1 cup butter, softened
- 3/4 cup sugar
- 2 eggs
- 1 tsp vanilla extract
- 1 tsp baking soda
- 2 cups chocolate chips

Instructions:
1. Preheat oven to 375Â°F
2. Mix butter and sugar until creamy
3. Add eggs and vanilla, beat well
4. Combine dry ingredients in separate bowl
5. Mix wet and dry ingredients
6. Fold in chocolate chips
7. Drop spoonfuls onto baking sheet
8. Bake for 10-12 minutes until golden

Serves: 24 cookies
Prep time: 15 minutes
Cook time: 12 minutes
ğŸ“ Parsing recipe from text...
ğŸ§  Parsing recipe from text using NLP...
âœ… SUCCESS (3ms)
   Content Type: text
   Method: text-parsing
   Confidence: 65%
   Extraction Methods: [nlp-parsing]
   Title: Chocolate Chip Cookies
   Ingredients: 15
   Instructions: 8


================================================================================
ğŸ“Š TEST SUMMARY

Total Tests: 7
âœ… Success: 5
âŒ Failed: 2
â­ï¸  Skipped: 0

Success Rate: 71.4%
================================================================================


================================================================================
ğŸ”¬ TESTING SPECIFIC FEATURES

================================================================================

TEST: Content Type Detection
--------------------------------------------------------------------------------
  https://allrecipes.com/recipe/123... â†’ expecting: website
  https://www.tiktok.com/@user/video/123... â†’ expecting: tiktok
  https://instagram.com/p/ABC/... â†’ expecting: instagram
  https://youtube.com/watch?v=ABC... â†’ expecting: youtube
  https://example.com/image.jpg... â†’ expecting: image
  https://example.com/recipe.pdf... â†’ expecting: pdf
  Just plain text here... â†’ expecting: text


TEST: NLP Recipe Parsing Quality
--------------------------------------------------------------------------------
ğŸ” Detected content type: text
âŒ Cache MISS: 
Easy Pancakes

These fluffy pancakes are perfect for breakfast!

You'll need:
- 2 cups flour
- 2 tablespoons sugar
- 2 teaspoons baking powder
- 1 cup milk
- 2 eggs
- 2 tablespoons melted butter

Steps:
1. Mix dry ingredients in a bowl
2. In another bowl, whisk milk, eggs, and butter
3. Combine wet and dry ingredients
4. Heat griddle to 350Â°F
5. Pour 1/4 cup batter for each pancake
6. Cook until bubbles form, then flip
7. Cook until golden brown

Makes 12 pancakes. Takes about 20 minutes.
  
ğŸ“ Parsing recipe from text...
ğŸ§  Parsing recipe from text using NLP...
âœ… NLP Parsing Results:
   Title: Easy Pancakes
   Description: These fluffy pancakes are perfect for breakfast!
   Ingredients Found: 13
   Instructions Found: 7
   Servings: 12
   Confidence: 70%

   Sample Ingredients:
     1. 2 cups flour
     2. 2 tablespoons sugar
     3. 2 teaspoons baking powder

   Sample Instructions:
     1. Mix dry ingredients in a bowl
     2. In another bowl, whisk milk, eggs, and butter
     3. Combine wet and dry ingredients

================================================================================


ğŸ‰ ALL TESTS COMPLETE!

The Universal Recipe Scraper is ready to handle:
  âœ… Regular recipe websites (JSON-LD, Microdata, HTML)
  âœ… TikTok videos (metadata + OCR + transcription)
  âœ… Instagram posts/reels (metadata + OCR)
  âœ… YouTube videos (metadata + transcript + description)
  âœ… Images (OCR with Google Vision + Tesseract fallback)
  âœ… Plain text (NLP parsing)
  âœ… PDFs (text extraction)
  âœ… Twitter/Facebook posts

================================================================================
â€‰ELIFECYCLEâ€‰ Command failed with exit code 1.
